@startuml 본인자산정보-입력
!theme mono

title 본인 자산정보 입력 플로우 (UFR-ASST-010)

actor "사용자" as User
participant "프론트엔드" as Frontend
participant "API Gateway" as Gateway
participant "Asset Service" as AssetService
database "Asset DB" as AssetDB

== 본인 자산정보 입력 화면 진입 ==
User -> Frontend: 기본정보 입력 완료 후\n자산정보 입력 화면 접근
Frontend -> Gateway: GET /api/assets/user/{userId}
note right: JWT 토큰 포함
Gateway -> AssetService: GET /assets/user/{userId}
AssetService -> AssetDB: SELECT * FROM user_assets\nWHERE user_id = {userId}\nAND owner_type = 'SELF'
AssetDB --> AssetService: 기존 자산정보 반환\n(없으면 빈 데이터)
AssetService --> Gateway: 200 OK\n{ assets: [], loans: [],\n  incomes: [], expenses: [] }
Gateway --> Frontend: 자산정보 데이터
Frontend --> User: 자산정보 입력 폼 표시\n(기존 데이터 로드)

== 자산 항목 추가 ==
User -> Frontend: 자산 추가 버튼 클릭
Frontend --> User: 자산 입력 폼 표시
User -> Frontend: 자산이름, 자산금액 입력
note right: 예: 예금, 5000만원
Frontend -> Frontend: 3초 debounce 타이머 시작

== 자동 저장 (3초 후) ==
Frontend -> Frontend: debounce 타이머 완료
Frontend -> Gateway: POST /api/assets/items
note right
  JWT 토큰 포함
  {
    userId: "user-id",
    ownerType: "SELF",
    itemType: "ASSET",
    name: "예금",
    amount: 50000000
  }
end note

Gateway -> AssetService: POST /assets/items
AssetService -> AssetService: 입력 검증\n- 필수 항목 확인\n- 금액 형식 검증\n- 항목명 중복 체크
AssetService -> AssetDB: INSERT INTO asset_items\n(user_id, owner_type, item_type,\n name, amount, created_at)
AssetDB --> AssetService: 저장 완료
AssetService -> AssetDB: SELECT SUM(amount)\nFROM asset_items\nWHERE user_id = {userId}\nAND owner_type = 'SELF'\nAND item_type = 'ASSET'
AssetDB --> AssetService: 총 자산액
AssetService --> Gateway: 201 Created\n{ id: "item-id",\n  totalAssets: 50000000 }
Gateway --> Frontend: 저장 성공 응답
Frontend --> User: 자산 카드 표시\n총 자산액 업데이트

== 대출 항목 추가 ==
User -> Frontend: 대출 추가 버튼 클릭
Frontend --> User: 대출 입력 폼 표시
User -> Frontend: 대출이름, 대출금액 입력
note right: 예: 학자금대출, 1000만원
Frontend -> Frontend: 3초 debounce 타이머 시작
Frontend -> Frontend: debounce 타이머 완료
Frontend -> Gateway: POST /api/assets/items
note right
  {
    userId: "user-id",
    ownerType: "SELF",
    itemType: "LOAN",
    name: "학자금대출",
    amount: 10000000
  }
end note
Gateway -> AssetService: POST /assets/items
AssetService -> AssetService: 입력 검증
AssetService -> AssetDB: INSERT INTO asset_items
AssetDB --> AssetService: 저장 완료
AssetService -> AssetDB: SELECT SUM(amount)\nWHERE item_type = 'LOAN'
AssetDB --> AssetService: 총 대출액
AssetService --> Gateway: 201 Created\n{ id: "item-id",\n  totalLoans: 10000000 }
Gateway --> Frontend: 저장 성공 응답
Frontend --> User: 대출 카드 표시\n총 대출액 업데이트

== 월소득 항목 추가 ==
User -> Frontend: 월소득 추가 버튼 클릭
Frontend --> User: 월소득 입력 폼 표시
User -> Frontend: 소득이름, 소득금액 입력
note right: 예: 급여, 300만원
Frontend -> Frontend: 3초 debounce 타이머 시작
Frontend -> Frontend: debounce 타이머 완료
Frontend -> Gateway: POST /api/assets/items
note right
  {
    userId: "user-id",
    ownerType: "SELF",
    itemType: "INCOME",
    name: "급여",
    amount: 3000000
  }
end note
Gateway -> AssetService: POST /assets/items
AssetService -> AssetService: 입력 검증
AssetService -> AssetDB: INSERT INTO asset_items
AssetDB --> AssetService: 저장 완료
AssetService -> AssetDB: SELECT SUM(amount)\nWHERE item_type = 'INCOME'
AssetDB --> AssetService: 총 월소득
AssetService --> Gateway: 201 Created\n{ id: "item-id",\n  totalIncome: 3000000 }
Gateway --> Frontend: 저장 성공 응답
Frontend --> User: 월소득 카드 표시\n총 월소득 업데이트

== 월지출 항목 추가 ==
User -> Frontend: 월지출 추가 버튼 클릭
Frontend --> User: 월지출 입력 폼 표시
User -> Frontend: 지출이름, 지출금액 입력
note right: 예: 생활비, 150만원
Frontend -> Frontend: 3초 debounce 타이머 시작
Frontend -> Frontend: debounce 타이머 완료
Frontend -> Gateway: POST /api/assets/items
note right
  {
    userId: "user-id",
    ownerType: "SELF",
    itemType: "EXPENSE",
    name: "생활비",
    amount: 1500000
  }
end note
Gateway -> AssetService: POST /assets/items
AssetService -> AssetService: 입력 검증
AssetService -> AssetDB: INSERT INTO asset_items
AssetDB --> AssetService: 저장 완료
AssetService -> AssetDB: SELECT SUM(amount)\nWHERE item_type = 'EXPENSE'
AssetDB --> AssetService: 총 월지출
AssetService --> Gateway: 201 Created\n{ id: "item-id",\n  totalExpense: 1500000 }
Gateway --> Frontend: 저장 성공 응답
Frontend --> User: 월지출 카드 표시\n총 월지출 업데이트

== 항목 수정 ==
User -> Frontend: 자산 카드의 편집 버튼 클릭
Frontend --> User: 수정 폼 표시 (기존 값)
User -> Frontend: 금액 수정
Frontend -> Frontend: 3초 debounce 타이머 시작
Frontend -> Frontend: debounce 타이머 완료
Frontend -> Gateway: PUT /api/assets/items/{itemId}
note right
  {
    name: "예금",
    amount: 55000000
  }
end note
Gateway -> AssetService: PUT /assets/items/{itemId}
AssetService -> AssetService: 입력 검증
AssetService -> AssetDB: UPDATE asset_items\nSET amount = 55000000,\n    updated_at = NOW()\nWHERE id = {itemId}
AssetDB --> AssetService: 수정 완료
AssetService -> AssetDB: SELECT SUM(amount)\nWHERE item_type = 'ASSET'
AssetDB --> AssetService: 총 자산액
AssetService --> Gateway: 200 OK\n{ totalAssets: 55000000 }
Gateway --> Frontend: 수정 성공 응답
Frontend --> User: 카드 업데이트\n총 자산액 재계산

== 항목 삭제 ==
User -> Frontend: 대출 카드의 삭제 버튼 클릭
Frontend --> User: 삭제 확인 다이얼로그
User -> Frontend: 확인 클릭
Frontend -> Gateway: DELETE /api/assets/items/{itemId}
note right: JWT 토큰 포함
Gateway -> AssetService: DELETE /assets/items/{itemId}
AssetService -> AssetDB: DELETE FROM asset_items\nWHERE id = {itemId}\nAND user_id = {userId}
AssetDB --> AssetService: 삭제 완료
AssetService -> AssetDB: SELECT SUM(amount)\nWHERE item_type = 'LOAN'
AssetDB --> AssetService: 총 대출액
AssetService --> Gateway: 200 OK\n{ totalLoans: 0 }
Gateway --> Frontend: 삭제 성공 응답
Frontend --> User: 카드 제거\n총 대출액 업데이트

== 최종 검증 및 다음 단계 ==
User -> Frontend: 저장 버튼 클릭
Frontend -> Frontend: 최소 1개 이상의\n자산 또는 소득 확인
alt 검증 성공
    Frontend --> User: "본인 자산정보가\n저장되었습니다" 메시지
    Frontend -> Frontend: 배우자 자산정보\n입력 화면으로 이동
else 검증 실패
    Frontend --> User: "최소 1개 이상의\n자산 또는 소득을\n입력해주세요" 오류
end

@enduml
