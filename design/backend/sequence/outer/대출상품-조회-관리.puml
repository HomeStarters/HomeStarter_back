@startuml 대출상품-조회-관리
!theme mono

title Flow 6: 대출상품 조회 및 관리

actor "사용자" as User
actor "관리자" as Admin
participant "Frontend\n(React)" as Frontend
participant "API Gateway" as Gateway
participant "Loan Service" as LoanService
database "Loan DB" as LoanDB
database "Redis Cache" as Cache

== UFR-LOAN-010: 대출상품 목록 조회 ==

User -> Frontend: 대출상품 목록 요청\n(필터/정렬 조건 포함)
activate Frontend

Frontend -> Gateway: GET /api/v1/loans/products\n?loanType={type}\n&minAmount={amount}\n&maxRate={rate}\n&sortBy={field}\n&page={page}&size={size}
activate Gateway

Gateway -> LoanService: GET /loans/products\n(필터/정렬 파라미터 전달)
activate LoanService

LoanService -> Cache: 캐시 조회\nkey: loans:list:{filters}
activate Cache
Cache --> LoanService: 캐시 데이터 또는 null
deactivate Cache

alt 캐시 미스
    LoanService -> LoanDB: SELECT loan_products\nWHERE conditions\nORDER BY sort_field\nLIMIT page, size
    activate LoanDB
    LoanDB --> LoanService: 대출상품 목록\n(페이징 포함)
    deactivate LoanDB

    LoanService -> Cache: 캐시 저장\nTTL: 1시간
    activate Cache
    Cache --> LoanService: 저장 완료
    deactivate Cache
end

LoanService --> Gateway: 200 OK\n{\n  "products": [\n    {\n      "id": "LOAN001",\n      "name": "신혼부부 특례대출",\n      "loanType": "JEONSE",\n      "maxAmount": 300000000,\n      "interestRate": 1.85,\n      "eligibility": {...}\n    }\n  ],\n  "totalCount": 45,\n  "page": 1,\n  "size": 20\n}
deactivate LoanService

Gateway --> Frontend: 200 OK\n(대출상품 목록 + 페이징 정보)
deactivate Gateway

Frontend --> User: 대출상품 목록 표시\n(필터/정렬/페이징 UI)
deactivate Frontend

== UFR-LOAN-020: 대출상품 상세 조회 ==

User -> Frontend: 대출상품 상세 조회 요청
activate Frontend

Frontend -> Gateway: GET /api/v1/loans/products/{productId}
activate Gateway

Gateway -> LoanService: GET /loans/products/{productId}
activate LoanService

LoanService -> Cache: 캐시 조회\nkey: loan:product:{productId}
activate Cache
Cache --> LoanService: 캐시 데이터 또는 null
deactivate Cache

alt 캐시 미스
    LoanService -> LoanDB: SELECT loan_product\nWHERE id = {productId}
    activate LoanDB
    LoanDB --> LoanService: 대출상품 상세 정보
    deactivate LoanDB

    LoanService -> LoanDB: SELECT required_documents\nWHERE product_id = {productId}
    activate LoanDB
    LoanDB --> LoanService: 필요 서류 목록
    deactivate LoanDB

    LoanService -> LoanDB: SELECT eligibility_criteria\nWHERE product_id = {productId}
    activate LoanDB
    LoanDB --> LoanService: 자격 조건 상세
    deactivate LoanDB

    LoanService -> Cache: 캐시 저장\nTTL: 2시간
    activate Cache
    Cache --> LoanService: 저장 완료
    deactivate Cache
end

LoanService --> Gateway: 200 OK\n{\n  "id": "LOAN001",\n  "name": "신혼부부 특례대출",\n  "description": "...",\n  "loanType": "JEONSE",\n  "maxAmount": 300000000,\n  "interestRate": 1.85,\n  "repaymentPeriod": 240,\n  "eligibility": {\n    "marriagePeriod": "7년 이내",\n    "income": "6천만원 이하",\n    "asset": "3.45억원 이하"\n  },\n  "requiredDocuments": [...],\n  "institution": {...}\n}
deactivate LoanService

Gateway --> Frontend: 200 OK\n(대출상품 상세 정보)
deactivate Gateway

Frontend --> User: 대출상품 상세 화면 표시\n(상세정보/자격조건/필요서류)
deactivate Frontend

== AFR-LOAN-030: 대출상품 관리 (관리자) ==

Admin -> Frontend: 대출상품 등록/수정 요청
activate Frontend

Frontend -> Gateway: POST /api/v1/loans/products\n(관리자 인증 토큰 포함)\n{\n  "name": "청년 디딤돌대출",\n  "loanType": "HOUSE_PURCHASE",\n  "maxAmount": 400000000,\n  "interestRate": 2.15,\n  "eligibility": {...},\n  "requiredDocuments": [...]\n}
activate Gateway

Gateway -> Gateway: 관리자 권한 검증
note right: JWT 토큰의\nrole=ADMIN 확인

alt 권한 없음
    Gateway --> Frontend: 403 Forbidden\n"관리자 권한 필요"
end

Gateway -> LoanService: POST /loans/products\n(대출상품 데이터)
activate LoanService

LoanService -> LoanService: 데이터 유효성 검증
note right
- 필수 필드 확인
- 금리 범위 검증
- 대출 금액 한도 확인
- 자격 조건 형식 검증
end note

alt 유효성 검증 실패
    LoanService --> Gateway: 400 Bad Request\n"유효성 검증 실패"
end

LoanService -> LoanDB: INSERT INTO loan_products\nVALUES (...)
activate LoanDB
LoanDB --> LoanService: 저장 완료\n(product_id 반환)
deactivate LoanDB

LoanService -> LoanDB: INSERT INTO eligibility_criteria\nVALUES (...)
activate LoanDB
LoanDB --> LoanService: 저장 완료
deactivate LoanDB

LoanService -> LoanDB: INSERT INTO required_documents\nVALUES (...)
activate LoanDB
LoanDB --> LoanService: 저장 완료
deactivate LoanDB

LoanService -> Cache: 관련 캐시 무효화\nkeys: loans:list:*,\nloan:product:{productId}
activate Cache
Cache --> LoanService: 무효화 완료
deactivate Cache

LoanService --> Gateway: 201 Created\n{\n  "id": "LOAN099",\n  "name": "청년 디딤돌대출",\n  "status": "ACTIVE",\n  "createdAt": "2025-12-16T10:30:00Z"\n}
deactivate LoanService

Gateway --> Frontend: 201 Created\n(생성된 대출상품 정보)
deactivate Gateway

Frontend --> Admin: 대출상품 등록 완료 알림
deactivate Frontend

note over Admin, LoanDB
대출상품 수정/삭제도 유사한 흐름:
- PUT /api/v1/loans/products/{id} (수정)
- DELETE /api/v1/loans/products/{id} (삭제)
- 모두 관리자 권한 필요
- 캐시 무효화 필수
end note

@enduml
