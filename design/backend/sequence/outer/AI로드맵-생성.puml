@startuml
!theme mono

title AI로드맵-생성 플로우 (Asynchronous Request-Reply 패턴)

actor "사용자" as User
participant "Frontend" as FE
participant "API Gateway" as GW
participant "Roadmap\nService" as Roadmap
participant "Message Queue\n(RabbitMQ)" as MQ
participant "AI Worker" as Worker
participant "User\nService" as UserSvc
participant "Asset\nService" as AssetSvc
participant "Housing\nService" as HousingSvc
participant "Calculator\nService" as CalcSvc
participant "LLM API\n(Claude/GPT)" as LLM
database "Roadmap\nDB" as RoadmapDB

== 생애주기 이벤트 입력 ==
User -> FE: 생애주기 이벤트 관리 화면 접근
FE -> GW: GET /roadmap/events\n이벤트 목록 조회
GW -> Roadmap: JWT 검증 후 요청 전달
Roadmap -> RoadmapDB: SELECT 이벤트 목록
RoadmapDB --> Roadmap: 이벤트 목록
Roadmap --> GW: 이벤트 목록
GW --> FE: 이벤트 목록
FE --> User: 타임라인 형태로 이벤트 표시

User -> FE: 이벤트 추가 (이름, 유형, 예정일, 고려기준)
FE -> GW: POST /roadmap/events
GW -> Roadmap: 이벤트 등록 요청
Roadmap -> RoadmapDB: INSERT 이벤트
RoadmapDB --> Roadmap: eventId
Roadmap --> GW: 등록 완료
GW --> FE: 등록 완료
FE --> User: "이벤트가 등록되었습니다"

== AI 로드맵 생성 요청 (비동기) ==
User -> FE: "로드맵 설계" 버튼 클릭
note right of User
    필수 조건:
    - 최종목표 주택 선택됨
    - 생애주기 이벤트 1개 이상
end note

FE -> GW: POST /roadmap/generate\n로드맵 생성 요청
GW -> Roadmap: JWT 검증 후 요청 전달

Roadmap -> Roadmap: 필수 조건 검증\n- 최종목표 주택 확인\n- 생애주기 이벤트 확인

alt 필수 조건 미충족
    Roadmap --> GW: 400 Bad Request\n"최종목표 주택을 먼저 선택하세요"
    GW --> FE: 오류 응답
    FE --> User: 안내 메시지 표시
else 필수 조건 충족
    Roadmap -> RoadmapDB: INSERT 작업 생성\nstatus: PENDING
    RoadmapDB --> Roadmap: taskId

    Roadmap -> MQ: PUBLISH 로드맵 생성 작업\n(taskId, userId, 입력 데이터)
    MQ --> Roadmap: 작업 등록 완료

    Roadmap --> GW: 202 Accepted\n{taskId, status: "PENDING"}
    GW --> FE: taskId 반환 (응답 시간 < 3초)
    FE --> User: "AI가 로드맵을 설계 중입니다..."\n진행률 0%

    == SSE 연결 ==
    FE -> GW: GET /roadmap/tasks/{taskId}/stream\nSSE 연결
    GW -> Roadmap: SSE 스트림 요청
    note over FE, Roadmap
        Server-Sent Events로
        실시간 진행 상황 전달
    end note
end

== 비동기 AI Worker 처리 ==
MQ ->> Worker: CONSUME 작업 메시지
Worker -> RoadmapDB: UPDATE status = PROCESSING\nprogress = 10%
Worker ->> Roadmap: 진행 상황 업데이트
Roadmap ->> FE: SSE: {progress: 10, message: "데이터 수집 시작"}
FE ->> User: 진행률 10% 표시

== 다중 서비스 데이터 수집 ==
par 병렬 데이터 수집
    Worker -> UserSvc: GET /users/profile\n기본정보 조회
    UserSvc --> Worker: 생년월일, 성별, 거주지, 투자성향
and
    Worker -> AssetSvc: GET /assets\n자산정보 조회
    AssetSvc --> Worker: 본인/배우자 자산, 소득, 지출
and
    Worker -> HousingSvc: GET /housing/target\n최종목표 주택 조회
    HousingSvc --> Worker: 주택정보, 입주희망년월
and
    Worker -> CalcSvc: GET /calculator/results?housingId={targetId}\n계산 결과 조회
    CalcSvc --> Worker: 입주 후 지출 계산 결과
end

Worker -> RoadmapDB: SELECT 생애주기 이벤트
RoadmapDB --> Worker: 이벤트 목록

Worker -> RoadmapDB: UPDATE progress = 30%
Worker ->> Roadmap: 진행 상황 업데이트
Roadmap ->> FE: SSE: {progress: 30, message: "데이터 수집 완료"}
FE ->> User: 진행률 30% 표시

== AI 분석 및 로드맵 생성 ==
Worker -> Worker: LLM 입력 데이터 구조화\n- 현재 재무상태\n- 최종목표 주택\n- 생애주기 이벤트\n- 투자성향

Worker -> RoadmapDB: UPDATE progress = 40%
Worker ->> Roadmap: 진행 상황 업데이트
Roadmap ->> FE: SSE: {progress: 40, message: "AI 분석 시작"}
FE ->> User: 진행률 40% 표시

Worker -> LLM: POST /chat/completions\n프롬프트: 단계별 주거 로드맵 설계
note right of Worker
    프롬프트 구성:
    1. 현재 재무상태 분석
    2. 최종목표 주택 분석
    3. 생애주기 이벤트 분석
    4. 단계별 계획 수립
    5. 실행가이드 생성
end note

Worker -> RoadmapDB: UPDATE progress = 60%
Worker ->> Roadmap: 진행 상황 업데이트
Roadmap ->> FE: SSE: {progress: 60, message: "AI 분석 중..."}
FE ->> User: 진행률 60% 표시

LLM --> Worker: AI 로드맵 결과\n- 단계별 주택 계획\n- 재무 목표\n- 실행 전략

Worker -> RoadmapDB: UPDATE progress = 80%
Worker ->> Roadmap: 진행 상황 업데이트
Roadmap ->> FE: SSE: {progress: 80, message: "로드맵 검증 중"}
FE ->> User: 진행률 80% 표시

== 결과 검증 및 저장 ==
Worker -> Worker: 결과 검증\n- 재무 논리 검증 (저축 가능 여부)\n- 시기 논리 검증 (이벤트 충돌)
Worker -> Worker: 응답 파싱 및 구조화

Worker -> RoadmapDB: INSERT 로드맵 결과 저장\n- 단계별 정보\n- 타임라인\n- 실행가이드
Worker -> RoadmapDB: UPDATE status = COMPLETED\nprogress = 100%
RoadmapDB --> Worker: roadmapId

Worker ->> Roadmap: 완료 알림
Roadmap ->> FE: SSE: {progress: 100, status: "COMPLETED", roadmapId}
FE ->> User: "로드맵이 완성되었습니다!" (완료 모달)
FE -> FE: SSE 연결 종료

== 로드맵 조회 ==
User -> FE: 로드맵 화면 이동
FE -> GW: GET /roadmap
GW -> Roadmap: 로드맵 조회 요청
Roadmap -> RoadmapDB: SELECT 로드맵
RoadmapDB --> Roadmap: 로드맵 데이터
Roadmap --> GW: 로드맵 데이터
GW --> FE: 로드맵 데이터
FE --> User: 타임라인 뷰 + 단계별 상세정보 표시

note right of User
    **타임라인 뷰**
    - 현재 → 1단계 → 2단계 → 최종목표
    - 생애주기 이벤트 마커

    **단계별 상세정보**
    - 추천 주택 특징
    - 재무 목표
    - 실행 전략

    **실행가이드**
    - 월별 저축 플랜
    - 주의사항 및 팁
end note

== 오류 처리 (Circuit Breaker) ==
alt LLM API 장애
    Worker -> LLM: API 호출 실패
    Worker -> Worker: Circuit Breaker 작동\n3회 재시도 후 실패
    Worker -> RoadmapDB: UPDATE status = FAILED\nerror: "LLM API 장애"
    Worker ->> Roadmap: 실패 알림
    Roadmap ->> FE: SSE: {status: "FAILED", error}
    FE ->> User: "일시적 오류가 발생했습니다.\n잠시 후 다시 시도해주세요."
end

@enduml
