@startuml 입주희망주택-입력-관리
!theme mono

title 입주희망 주택정보 입력 및 관리 플로우

actor "사용자" as User
participant "Frontend" as FE
participant "API Gateway" as GW
participant "Housing Service" as HS
participant "Database" as DB
participant "Kakao Map API" as Kakao
participant "Event Bus" as EB

== UFR-HOUS-010: 입주희망 주택정보 입력 ==

User -> FE: 주택정보 입력 화면 요청
FE -> User: 입력 폼 표시

User -> FE: 주택정보 입력\n(주소, 면적, 가격, 교통호재 등)
FE -> FE: 입력값 검증

FE -> GW: POST /api/housings\n(주택정보, 교통호재, 출퇴근시간)
GW -> HS: POST /housings

HS -> HS: 입력값 유효성 검증
HS -> DB: 주택정보 저장
DB --> HS: 저장 완료

HS -> DB: 교통호재 정보 저장\n(중첩 데이터)
DB --> HS: 저장 완료

HS -> DB: 출퇴근 시간 정보 저장\n(중첩 데이터)
DB --> HS: 저장 완료

alt Kakao Map API 연동 성공
    HS -> Kakao: 주소 → 좌표 변환 요청\n(Circuit Breaker 적용)
    Kakao --> HS: 위도/경도 반환
    HS -> DB: 좌표 정보 업데이트
    DB --> HS: 업데이트 완료
else Circuit Breaker Open 또는 API 실패
    HS -> HS: 기본값 설정 또는 재시도 대기
    note right: Circuit Breaker로\n장애 격리
end

HS -> EB: HousingCreated 이벤트 발행
note right
  이벤트 페이로드:
  - housingId
  - userId
  - address
  - createdAt
end note

HS --> GW: 201 Created\n(주택 ID, 전체 정보)
GW --> FE: 201 Created
FE -> User: 등록 완료 메시지 표시

== UFR-HOUS-020: 주택 목록 조회 ==

User -> FE: 주택 목록 조회 요청
FE -> GW: GET /api/housings\n?page=0&size=10&sort=createdAt,desc
GW -> HS: GET /housings

HS -> DB: 사용자별 주택 목록 조회\n(페이징, 정렬)
DB --> HS: 주택 목록 반환

HS -> HS: 목록 응답 DTO 변환
HS --> GW: 200 OK\n(주택 목록, 페이지 정보)
GW --> FE: 200 OK
FE -> User: 주택 목록 표시

== UFR-HOUS-030: 주택 상세 조회 ==

User -> FE: 특정 주택 상세 조회
FE -> GW: GET /api/housings/{housingId}
GW -> HS: GET /housings/{housingId}

HS -> DB: 주택 기본정보 조회
DB --> HS: 주택 정보 반환

HS -> DB: 교통호재 정보 조회\n(중첩 데이터)
DB --> HS: 교통호재 목록 반환

HS -> DB: 출퇴근 시간 정보 조회\n(중첩 데이터)
DB --> HS: 출퇴근 시간 목록 반환

HS -> HS: 상세 응답 DTO 조합
HS --> GW: 200 OK\n(주택 상세정보)
GW --> FE: 200 OK
FE -> User: 주택 상세정보 표시\n(지도 포함)

== UFR-HOUS-040: 주택정보 수정 ==

User -> FE: 주택정보 수정 화면 요청
FE -> GW: GET /api/housings/{housingId}
GW -> HS: GET /housings/{housingId}
HS -> DB: 주택정보 조회
DB --> HS: 기존 정보 반환
HS --> GW: 200 OK
GW --> FE: 200 OK
FE -> User: 수정 폼 표시\n(기존 데이터 채움)

User -> FE: 정보 수정 후 저장
FE -> FE: 입력값 검증
FE -> GW: PUT /api/housings/{housingId}\n(수정된 정보)
GW -> HS: PUT /housings/{housingId}

HS -> HS: 수정 권한 확인\n(소유자 검증)
HS -> DB: 주택 기본정보 업데이트
DB --> HS: 업데이트 완료

HS -> DB: 교통호재 정보 업데이트\n(기존 삭제 후 재등록)
DB --> HS: 업데이트 완료

HS -> DB: 출퇴근 시간 정보 업데이트\n(기존 삭제 후 재등록)
DB --> HS: 업데이트 완료

alt 주소 변경된 경우
    HS -> Kakao: 새 주소 → 좌표 변환\n(Circuit Breaker 적용)
    Kakao --> HS: 새 좌표 반환
    HS -> DB: 좌표 정보 업데이트
    DB --> HS: 업데이트 완료
end

HS -> EB: HousingUpdated 이벤트 발행
note right
  이벤트 페이로드:
  - housingId
  - userId
  - updatedFields
  - updatedAt
end note

HS --> GW: 200 OK\n(업데이트된 정보)
GW --> FE: 200 OK
FE -> User: 수정 완료 메시지 표시

== UFR-HOUS-050: 최종목표 주택 선택 ==

User -> FE: 주택 목록에서\n최종목표 주택 선택
FE -> GW: PATCH /api/housings/{housingId}/set-final
GW -> HS: PATCH /housings/{housingId}/set-final

HS -> HS: 소유자 권한 확인
HS -> DB: 기존 최종목표 주택 해제\n(isFinal = false)
DB --> HS: 해제 완료

HS -> DB: 선택한 주택을 최종목표로 설정\n(isFinal = true)
DB --> HS: 설정 완료

HS -> EB: FinalHousingSelected 이벤트 발행
note right
  이벤트 페이로드:
  - housingId
  - userId
  - selectedAt
end note

HS --> GW: 200 OK\n(최종목표 주택 정보)
GW --> FE: 200 OK
FE -> User: 최종목표 주택 설정 완료\n메시지 표시

@enduml
