@startuml loan-대출상품상세조회
!theme mono

title Loan 서비스 - 대출상품 상세 조회 (UFR-LOAN-020)

participant "LoanController" as Controller
participant "LoanProductService" as Service
participant "LoanProductRepository" as Repository
database "Redis Cache<<E>>" as Cache
database "Loan DB<<E>>" as DB

note over Controller, DB
시나리오: 사용자가 특정 대출상품의 상세 정보를 조회
- 캐시 우선 전략 (Cache-Aside 패턴)
- 상세 정보: 기본정보 + 자격요건 + 필요서류
- 캐시 TTL: 2시간 (목록보다 길게 설정)
end note

activate Controller

Controller -> Service: 대출상품 상세 조회 요청\n(productId)
activate Service

Service -> Service: productId 유효성 검증
note right
- null/empty 확인
- 형식 검증
end note

Service -> Cache: 캐시 조회\nkey: "loan:product:{productId}"
activate Cache
Cache --> Service: 캐시 데이터 또는 null
deactivate Cache

alt 캐시 히트
    Service --> Controller: 대출상품 상세 정보\n(캐시 데이터)
    note right
    캐시에서 직접 반환
    DB 조회 생략
    end note
else 캐시 미스
    Service -> Repository: 대출상품 기본정보 조회\n(productId)
    activate Repository

    Repository -> DB: 대출상품 조회\nWHERE id = productId
    activate DB
    note right
    loan_products 테이블에서
    기본 정보 조회
    end note
    DB --> Repository: 대출상품 기본 정보
    deactivate DB

    alt 상품이 존재하지 않음
        Repository --> Service: null
        Service --> Controller: 404 Not Found
        note right
        존재하지 않는 상품
        end note
    else 상품이 존재함
        Repository --> Service: 대출상품 기본 정보
        deactivate Repository

        Service -> Repository: 자격요건 조회\n(productId)
        activate Repository

        Repository -> DB: 자격요건 조회\nWHERE product_id = productId
        activate DB
        note right
        eligibility_criteria 테이블에서
        자격 조건 상세 조회
        end note
        DB --> Repository: 자격요건 목록
        deactivate DB

        Repository --> Service: 자격요건 목록
        deactivate Repository

        Service -> Repository: 필요서류 조회\n(productId)
        activate Repository

        Repository -> DB: 필요서류 조회\nWHERE product_id = productId
        activate DB
        note right
        required_documents 테이블에서
        필요 서류 목록 조회
        end note
        DB --> Repository: 필요서류 목록
        deactivate DB

        Repository --> Service: 필요서류 목록
        deactivate Repository

        Service -> Service: 응답 DTO 통합 생성
        note right
        - 기본정보 + 자격요건 + 필요서류
        - Entity → LoanProductDetailResponse
        - 민감 정보 필터링
        end note

        Service -> Cache: 캐시 저장\nkey: "loan:product:{productId}"\nTTL: 2시간
        activate Cache
        note right
        상세 정보는 자주 조회되므로
        목록보다 긴 TTL 설정
        end note
        Cache --> Service: 저장 완료
        deactivate Cache

        Service --> Controller: 대출상품 상세 정보
    end
end

deactivate Service

Controller -> Controller: HTTP 응답 생성
note right
200 OK
{
  "id": "LOAN001",
  "name": "신혼부부 특례대출",
  "description": "...",
  "loanType": "JEONSE",
  "maxAmount": 300000000,
  "interestRate": 1.85,
  "eligibility": {...},
  "requiredDocuments": [...]
}
end note

Controller --> : HTTP 응답 반환
deactivate Controller

@enduml
