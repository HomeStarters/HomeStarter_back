@startuml loan-대출상품목록조회
!theme mono

title Loan 서비스 - 대출상품 목록 조회 (UFR-LOAN-010)

participant "LoanController" as Controller
participant "LoanProductService" as Service
participant "LoanProductRepository" as Repository
database "Redis Cache<<E>>" as Cache
database "Loan DB<<E>>" as DB

note over Controller, DB
시나리오: 사용자가 대출상품 목록을 필터/정렬/페이징 조건과 함께 조회
- 캐시 우선 전략 (Cache-Aside 패턴)
- 필터: 대출유형, 대출금액, 금리 등
- 정렬: 금리순, 한도순
- 페이징: page, size 파라미터
end note

activate Controller

Controller -> Service: 대출상품 목록 조회 요청\n(필터/정렬/페이징 조건)
activate Service

Service -> Service: 캐시 키 생성\nkey: "loans:list:{filters}"
note right
필터 조건을 해시하여
캐시 키 생성
end note

Service -> Cache: 캐시 조회\nkey: "loans:list:{filters}"
activate Cache
Cache --> Service: 캐시 데이터 또는 null
deactivate Cache

alt 캐시 히트
    Service --> Controller: 대출상품 목록\n(캐시 데이터)
    note right
    캐시에서 직접 반환
    DB 조회 생략
    end note
else 캐시 미스
    Service -> Service: 검색 조건 유효성 검증
    note right
    - 페이지 번호 양수 확인
    - 페이지 크기 범위 확인 (1-100)
    - 정렬 필드 화이트리스트 검증
    end note

    Service -> Repository: 대출상품 목록 조회\n(필터/정렬/페이징 조건)
    activate Repository

    Repository -> DB: 대출상품 조회\n(조건부 필터링, 정렬, 페이징)
    activate DB
    note right
    - WHERE 조건: loan_type, min_amount, max_rate
    - ORDER BY: interest_rate, max_amount 등
    - LIMIT/OFFSET: 페이징 처리
    - 활성화된 상품만 조회 (status = 'ACTIVE')
    end note
    DB --> Repository: 대출상품 목록 데이터
    deactivate DB

    Repository -> DB: 전체 개수 조회\n(COUNT 쿼리)
    activate DB
    note right
    페이징을 위한
    전체 레코드 수 조회
    end note
    DB --> Repository: 전체 개수
    deactivate DB

    Repository --> Service: 대출상품 목록 + 전체 개수
    deactivate Repository

    Service -> Service: 응답 DTO 변환
    note right
    Entity → LoanProductListResponse
    - 페이징 정보 구성
    - 민감 정보 제외
    end note

    Service -> Cache: 캐시 저장\nkey: "loans:list:{filters}"\nTTL: 1시간
    activate Cache
    note right
    조회 성능 향상을 위한
    캐시 저장
    대출상품은 자주 변경되지 않음
    end note
    Cache --> Service: 저장 완료
    deactivate Cache

    Service --> Controller: 대출상품 목록\n(페이징 정보 포함)
end

deactivate Service

Controller -> Controller: HTTP 응답 생성
note right
200 OK
{
  "products": [...],
  "totalCount": 45,
  "page": 1,
  "size": 20,
  "totalPages": 3
}
end note

Controller --> : HTTP 응답 반환
deactivate Controller

@enduml
