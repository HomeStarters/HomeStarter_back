@startuml loan-대출상품삭제
!theme mono

title Loan 서비스 - 대출상품 삭제 (AFR-LOAN-030 - 관리자)

participant "LoanController" as Controller
participant "AuthorizationService" as AuthService
participant "LoanProductService" as Service
participant "LoanProductRepository" as Repository
database "Redis Cache<<E>>" as Cache
database "Loan DB<<E>>" as DB

note over Controller, DB
시나리오: 관리자가 기존 대출상품을 삭제
- JWT 토큰 검증 (role=ADMIN)
- 존재 여부 확인
- 삭제 가능 여부 확인 (참조 무결성)
- 논리적 삭제 (soft delete) 또는 물리적 삭제
- 캐시 무효화
end note

activate Controller

Controller -> AuthService: JWT 토큰 검증 및 권한 확인
activate AuthService
note right
Authorization 헤더에서
JWT 토큰 추출 및 검증
end note

AuthService -> AuthService: 토큰 파싱 및 검증
note right
- 토큰 유효성 확인
- 만료 시간 확인
- 서명 검증
- role=ADMIN 확인
end note

alt 인증/권한 실패
    AuthService --> Controller: 401/403 오류
    Controller --> : HTTP 401/403 응답
else 인증 및 권한 확인 성공
    AuthService --> Controller: 관리자 정보
    deactivate AuthService

    Controller -> Service: 대출상품 삭제 요청\n(productId)
    activate Service

    Service -> Repository: 대출상품 존재 확인\n(productId)
    activate Repository

    Repository -> DB: 대출상품 조회\nWHERE id = productId
    activate DB
    DB --> Repository: 대출상품 정보 또는 null
    deactivate DB

    alt 상품이 존재하지 않음
        Repository --> Service: null
        Service --> Controller: 404 Not Found
        Controller --> : HTTP 404 응답
        note right
        존재하지 않는 상품
        end note
    else 상품이 존재함
        Repository --> Service: 대출상품 정보
        deactivate Repository

        Service -> Repository: 사용 중 여부 확인\n(productId)
        activate Repository
        note right
        다른 서비스에서
        해당 대출상품을 참조하는지 확인
        예: Calculator 서비스의
        계산 결과에서 사용 중인지
        end note

        Repository -> DB: 참조 확인 쿼리\n(외부 시스템 확인)
        activate DB
        note right
        실제로는 Calculator 서비스 API 호출
        또는 이벤트 기반 확인 필요
        여기서는 간소화
        end note
        DB --> Repository: 사용 여부
        deactivate DB

        alt 사용 중인 경우
            Repository --> Service: 사용 중 경고
            Service --> Controller: 409 Conflict
            Controller --> : HTTP 409 응답
            note right
            "이 대출상품은 현재 사용 중입니다.
            삭제할 수 없습니다."
            end note
        else 사용하지 않는 경우
            Repository --> Service: 삭제 가능
            deactivate Repository

            Service -> Service: 삭제 방식 결정
            note right
            논리적 삭제 (권장):
            - status를 'DELETED'로 변경
            - 데이터 보존
            - 이력 추적 가능

            물리적 삭제:
            - 데이터 완전 삭제
            - 외래 키 제약 처리 필요
            end note

            Service -> Repository: 트랜잭션 시작
            activate Repository

            alt 논리적 삭제 (권장)
                Repository -> DB: 상태 변경\nUPDATE loan_products\nSET status = 'DELETED',\n    deletedAt = NOW()\nWHERE id = productId
                activate DB
                note right
                논리적 삭제:
                - status: ACTIVE → DELETED
                - deletedAt 기록
                - 데이터는 보존
                end note
                DB --> Repository: 업데이트 완료
                deactivate DB
            else 물리적 삭제
                Repository -> DB: 필요서류 삭제\nDELETE FROM required_documents\nWHERE product_id = productId
                activate DB
                note right
                외래 키 참조 데이터
                먼저 삭제
                end note
                DB --> Repository: 삭제 완료
                deactivate DB

                Repository -> DB: 자격요건 삭제\nDELETE FROM eligibility_criteria\nWHERE product_id = productId
                activate DB
                DB --> Repository: 삭제 완료
                deactivate DB

                Repository -> DB: 대출상품 삭제\nDELETE FROM loan_products\nWHERE id = productId
                activate DB
                note right
                메인 데이터 삭제
                end note
                DB --> Repository: 삭제 완료
                deactivate DB
            end

            Repository -> Repository: 트랜잭션 커밋
            note right
            모든 삭제 작업이
            성공한 경우에만 커밋
            end note

            Repository --> Service: 삭제 완료
            deactivate Repository

            Service -> Cache: 캐시 무효화\nkeys: "loans:list:*", "loan:product:{productId}"
            activate Cache
            note right
            목록 캐시 + 상세 캐시 삭제:
            - 목록에서 삭제된 상품 제거
            - 상세 페이지 접근 불가
            end note
            Cache --> Service: 무효화 완료
            deactivate Cache

            Service --> Controller: 삭제 완료 확인
        end
    end
end

deactivate Service

Controller -> Controller: HTTP 응답 생성
note right
204 No Content
또는
200 OK
{
  "message": "대출상품이 삭제되었습니다.",
  "deletedId": "LOAN001",
  "deletedAt": "2025-12-16T12:00:00Z"
}
end note

Controller --> : HTTP 응답 반환
deactivate Controller

@enduml
