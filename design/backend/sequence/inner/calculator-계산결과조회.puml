@startuml
!theme mono

title Calculator 서비스 - 계산결과조회 (내부 시퀀스)

participant "CalculatorController" as Ctrl
participant "ExpenseCalculator\nService" as Svc
participant "Calculator\nRepository" as Repo
database "Calculator DB" as DB
database "Redis Cache<<E>>" as Cache

== 계산 결과 목록 조회 (GET /calculator/results) ==
[-> Ctrl: GET /calculator/results\n?userId={userId}&page={page}&size={size}
activate Ctrl

Ctrl -> Svc: getCalculationResults(userId, pageable)
activate Svc

note right of Svc
    사용자의 모든 계산 결과 조회
    페이징 처리 지원
end note

== 캐시 조회 (목록 전용 캐시) ==
Svc -> Svc: 캐시 키 생성\ncalc:list:{userId}:{page}:{size}

Svc -> Cache: GET 캐시 조회
activate Cache

alt 캐시 히트
    Cache --> Svc: 캐시된 목록 데이터
    deactivate Cache

    Svc --> Ctrl: Page<CalculationSummaryResponse>
    deactivate Svc
    Ctrl --> [: 200 OK\n계산 결과 목록
    deactivate Ctrl

else 캐시 미스
    Cache --> Svc: null
    deactivate Cache

    == 데이터베이스 조회 ==
    Svc -> Repo: findByUserId(userId, pageable)
    activate Repo

    Repo -> DB: SELECT * FROM calculation_results\nWHERE user_id = {userId}\nORDER BY created_at DESC\nLIMIT {size} OFFSET {offset}
    DB --> Repo: List<CalculationEntity>

    Repo -> DB: SELECT COUNT(*) FROM calculation_results\nWHERE user_id = {userId}
    DB --> Repo: total count

    Repo --> Svc: Page<CalculationEntity>
    deactivate Repo

    note right of Svc
        엔티티를 DTO로 변환
        필요한 정보만 추출
    end note

    Svc -> Svc: toSummaryResponse(entities)

    == 목록 캐싱 ==
    Svc -> Cache: SET 목록 캐싱\nKey: calc:list:{userId}:{page}:{size}\nTTL: 300초 (5분)
    activate Cache
    Cache --> Svc: OK
    deactivate Cache

    note right of Cache
        목록 캐시:
        - TTL: 5분 (상세보다 짧음)
        - 신규 계산 시 무효화
    end note

    Svc --> Ctrl: Page<CalculationSummaryResponse>
    deactivate Svc
    Ctrl --> [: 200 OK\n계산 결과 목록
    deactivate Ctrl
end

note over Ctrl, Cache
    **응답 데이터 (CalculationSummaryResponse)**:
    - resultId: 결과 ID
    - housingName: 주택이름
    - loanProductName: 대출상품명
    - calculatedAt: 계산일시
    - isEligible: 충족여부 (true/false)
    - monthlyBalance: 입주 후 여유자금
    - createdAt: 생성일시
end note

== 계산 결과 상세 조회 (GET /calculator/results/{resultId}) ==
[-> Ctrl: GET /calculator/results/{resultId}
activate Ctrl

Ctrl -> Svc: getCalculationResultById(resultId)
activate Svc

== 캐시 조회 (상세 전용 캐시) ==
Svc -> Svc: 캐시 키 생성\ncalc:detail:{resultId}

Svc -> Cache: GET 캐시 조회
activate Cache

alt 캐시 히트
    Cache --> Svc: 캐시된 상세 데이터
    deactivate Cache

    Svc --> Ctrl: CalculationResponse
    deactivate Svc
    Ctrl --> [: 200 OK\n계산 결과 상세
    deactivate Ctrl

else 캐시 미스
    Cache --> Svc: null
    deactivate Cache

    == 데이터베이스 조회 ==
    Svc -> Repo: findById(resultId)
    activate Repo

    Repo -> DB: SELECT * FROM calculation_results\nWHERE result_id = {resultId}
    DB --> Repo: CalculationEntity

    Repo --> Svc: Optional<CalculationEntity>
    deactivate Repo

    alt 결과 존재
        Svc -> Svc: toResponse(entity)

        == 상세 캐싱 ==
        Svc -> Cache: SET 상세 캐싱\nKey: calc:detail:{resultId}\nTTL: 3600초 (1시간)
        activate Cache
        Cache --> Svc: OK
        deactivate Cache

        Svc --> Ctrl: CalculationResponse
        deactivate Svc
        Ctrl --> [: 200 OK\n계산 결과 상세
        deactivate Ctrl

    else 결과 없음
        Svc --> Ctrl: throw NotFoundException
        deactivate Svc
        Ctrl --> [: 404 Not Found
        deactivate Ctrl
    end
end

note over Ctrl, Cache
    **응답 데이터 (CalculationResponse)**:
    - resultId: 결과 ID
    - userId: 사용자 ID
    - housingId: 주택 ID
    - loanId: 대출상품 ID

    **재무 현황**:
    - estimatedAsset: 예상자산
    - loanNeeded: 대출필요금액

    **대출 분석**:
    - calculatedLTV/DTI/DSR
    - isEligible: 충족여부
    - eligibilityDetails: 상세 사유

    **입주 후 재무상태**:
    - assetAfterMove: 예상 자산
    - monthlyExpenseAfterMove: 월지출액
    - monthlyBalance: 여유자금

    - calculatedAt: 계산일시
    - createdAt: 생성일시
end note

== 계산 결과 삭제 (DELETE /calculator/results/{resultId}) ==
[-> Ctrl: DELETE /calculator/results/{resultId}\n?userId={userId}
activate Ctrl

Ctrl -> Svc: deleteCalculationResult(resultId, userId)
activate Svc

note right of Svc
    본인의 계산 결과만 삭제 가능
    권한 확인 필수
end note

== 권한 확인 및 삭제 ==
Svc -> Repo: findByIdAndUserId(resultId, userId)
activate Repo

Repo -> DB: SELECT * FROM calculation_results\nWHERE result_id = {resultId}\nAND user_id = {userId}
DB --> Repo: CalculationEntity

Repo --> Svc: Optional<CalculationEntity>
deactivate Repo

alt 결과 존재 및 권한 있음
    Svc -> Repo: deleteById(resultId)
    activate Repo

    Repo -> DB: DELETE FROM calculation_results\nWHERE result_id = {resultId}
    DB --> Repo: 삭제 완료

    Repo --> Svc: void
    deactivate Repo

    == 관련 캐시 무효화 ==
    Svc -> Cache: DEL calc:detail:{resultId}
    activate Cache
    Cache --> Svc: OK
    deactivate Cache

    Svc -> Cache: DEL calc:list:{userId}:*\n(목록 캐시 패턴 삭제)
    activate Cache
    Cache --> Svc: 삭제된 키 수
    deactivate Cache

    note right of Svc
        목록 캐시는 패턴 매칭으로
        모든 페이지 캐시 무효화
    end note

    Svc --> Ctrl: void
    deactivate Svc
    Ctrl --> [: 204 No Content
    deactivate Ctrl

else 결과 없음 또는 권한 없음
    Svc --> Ctrl: throw NotFoundException or ForbiddenException
    deactivate Svc
    Ctrl --> [: 404 Not Found or 403 Forbidden
    deactivate Ctrl
end

@enduml
