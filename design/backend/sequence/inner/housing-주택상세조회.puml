@startuml housing-주택상세조회
!theme mono

title Housing Service - 주택 상세 조회 내부 시퀀스 (UFR-HOUS-030)

participant "HousingController" as HC
participant "HousingService" as HS
participant "HousingRepository" as HR
participant "TransportRepository" as TR
participant "CommuteTimeRepository" as CTR
database "Housing DB" as DB
database "Redis Cache<<E>>" as Cache

== 주택 상세 조회 ==

-> HC: GET /housings/{housingId}
activate HC

HC -> HC: JWT에서 userId 추출

HC -> HS: 주택 상세 조회 요청\n(housingId, userId)
activate HS

HS -> Cache: 캐시 조회 시도\nkey: "housing:detail:{housingId}"
activate Cache

alt 캐시 히트
    Cache --> HS: 캐시된 상세정보 반환
    deactivate Cache

    note right of HS
      캐시 TTL: 10분
      상세 조회 성능 최적화
    end note

else 캐시 미스
    Cache --> HS: null
    deactivate Cache

    HS -> HR: 주택 기본정보 조회
    activate HR

    HR -> DB: SELECT * FROM housing\nWHERE id = ?\nAND user_id = ?
    note right of DB
      소유자 확인:
      user_id 조건으로
      다른 사용자 주택 조회 차단
    end note

    DB --> HR: Housing 엔티티

    alt 주택 없음
        HR --> HS: null
        deactivate HR
        HS --> HC: EntityNotFoundException
        HC --> : 404 Not Found\n"주택을 찾을 수 없습니다"
    else 주택 존재
        HR --> HS: Housing 엔티티
        deactivate HR

        HS -> TR: 교통호재 정보 조회
        activate TR

        TR -> DB: SELECT * FROM transport_benefit\nWHERE housing_id = ?\nORDER BY opening_date
        note right of DB
          중첩 데이터:
          - 교통호재명
          - 개통시기
        end note

        DB --> TR: TransportBenefit 목록
        TR --> HS: List<TransportBenefit>
        deactivate TR

        loop 각 교통호재별
            HS -> CTR: 출퇴근 시간 정보 조회
            activate CTR

            CTR -> DB: SELECT * FROM commute_time\nWHERE transport_benefit_id = ?
            note right of DB
              출퇴근 시간:
              - 본인 개통 전/후
              - 배우자 개통 전/후
            end note

            DB --> CTR: CommuteTime 엔티티
            CTR --> HS: CommuteTime
            deactivate CTR

            HS -> HS: 교통호재에 출퇴근 시간 연결
        end

        HS -> HS: 상세 응답 DTO 조합
        note right of HS
          HousingDetailResponse:
          - 주택 기본정보
          - 교통호재 목록
            - 각 호재별 출퇴근 시간
          - 좌표 정보 (지도 표시용)
        end note

        HS -> Cache: 상세정보 캐싱 (10분)
        activate Cache
        Cache --> HS: 캐싱 완료
        deactivate Cache
    end
end

HS --> HC: HousingDetailResponse
deactivate HS

HC --> : 200 OK\n(주택 상세정보)
deactivate HC

@enduml
