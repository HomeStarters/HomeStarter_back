@startuml
!theme mono

title Roadmap 서비스 - 생애주기 이벤트 입력

participant "Controller" as Ctrl
participant "Service" as Svc
participant "Repository" as Repo
database "Roadmap DB" as DB

== 생애주기 이벤트 목록 조회 ==
-> Ctrl: GET /roadmap/events\n이벤트 목록 조회 요청

Ctrl -> Svc: 이벤트 목록 조회 요청
activate Svc
note right of Svc
  사용자 ID는 JWT에서 추출
  인증된 사용자만 접근 가능
end note

Svc -> Repo: userId로 이벤트 목록 조회
activate Repo
Repo -> DB: 사용자의 이벤트 목록 SELECT\n날짜순 정렬
DB --> Repo: 이벤트 목록
deactivate Repo

Svc --> Ctrl: 이벤트 목록 DTO
deactivate Svc
Ctrl --> : 200 OK\n이벤트 목록 반환

== 생애주기 이벤트 추가 ==
-> Ctrl: POST /roadmap/events\n이벤트 등록 요청\n{이름, 유형, 예정일, 고려기준}

Ctrl -> Ctrl: 요청 데이터 검증
note right of Ctrl
  필수 필드 검증:
  - 이벤트 이름 (최대 100자)
  - 이벤트 유형 (결혼/출산/자녀교육/은퇴/기타)
  - 이벤트 예정일 (년월, 미래 날짜)
  - 주택선택 고려기준 (최대 200자)
end note

alt 검증 실패
  Ctrl --> : 400 Bad Request\n검증 오류 메시지
else 검증 성공
  Ctrl -> Svc: 이벤트 등록 요청
  activate Svc

  Svc -> Svc: 비즈니스 로직 검증
  note right of Svc
    - 이벤트 날짜 논리 검증
    - 출산 이후에 자녀교육 있는지 확인
    - 동일 날짜 중복 이벤트 제한
  end note

  Svc -> Repo: 이벤트 생성
  activate Repo
  Repo -> DB: 이벤트 INSERT\n- userId\n- eventName\n- eventType\n- eventDate\n- housingCriteria\n- createdAt
  DB --> Repo: eventId 생성
  deactivate Repo

  Svc -> Repo: 생성된 이벤트 조회
  activate Repo
  Repo -> DB: eventId로 조회
  DB --> Repo: 이벤트 상세
  deactivate Repo

  Svc --> Ctrl: 생성된 이벤트 DTO
  deactivate Svc

  Ctrl --> : 201 Created\n생성된 이벤트 정보
end

== 생애주기 이벤트 수정 ==
-> Ctrl: PUT /roadmap/events/{eventId}\n이벤트 수정 요청

Ctrl -> Ctrl: 요청 데이터 검증
note right of Ctrl
  수정 가능 필드:
  - 이벤트 이름
  - 이벤트 유형
  - 이벤트 예정일
  - 주택선택 고려기준
end note

alt 검증 실패
  Ctrl --> : 400 Bad Request
else 검증 성공
  Ctrl -> Svc: 이벤트 수정 요청
  activate Svc

  Svc -> Repo: eventId로 이벤트 존재 확인
  activate Repo
  Repo -> DB: eventId 조회
  DB --> Repo: 이벤트 또는 null
  deactivate Repo

  alt 이벤트 없음
    Svc --> Ctrl: 이벤트 없음 예외
    Ctrl --> : 404 Not Found\n이벤트를 찾을 수 없습니다
  else 권한 확인
    Svc -> Svc: userId 일치 여부 확인
    alt userId 불일치
      Svc --> Ctrl: 권한 없음 예외
      Ctrl --> : 403 Forbidden\n수정 권한이 없습니다
    else 수정 가능
      Svc -> Repo: 이벤트 업데이트
      activate Repo
      Repo -> DB: 이벤트 UPDATE\nupdatedAt 갱신
      DB --> Repo: 업데이트 완료
      deactivate Repo

      Svc -> Repo: 수정된 이벤트 조회
      activate Repo
      Repo -> DB: eventId로 조회
      DB --> Repo: 업데이트된 이벤트
      deactivate Repo

      Svc --> Ctrl: 수정된 이벤트 DTO
      deactivate Svc

      Ctrl --> : 200 OK\n수정된 이벤트 정보
    end
  end
end

== 생애주기 이벤트 삭제 ==
-> Ctrl: DELETE /roadmap/events/{eventId}\n이벤트 삭제 요청

Ctrl -> Svc: 이벤트 삭제 요청
activate Svc

Svc -> Repo: eventId로 이벤트 존재 확인
activate Repo
Repo -> DB: eventId 조회
DB --> Repo: 이벤트 또는 null
deactivate Repo

alt 이벤트 없음
  Svc --> Ctrl: 이벤트 없음 예외
  Ctrl --> : 404 Not Found
else 권한 확인
  Svc -> Svc: userId 일치 여부 확인
  alt userId 불일치
    Svc --> Ctrl: 권한 없음 예외
    Ctrl --> : 403 Forbidden
  else 삭제 가능
    Svc -> Repo: 이벤트 삭제
    activate Repo
    Repo -> DB: 이벤트 DELETE\n(또는 soft delete)
    DB --> Repo: 삭제 완료
    deactivate Repo

    Svc --> Ctrl: 삭제 완료
    deactivate Svc

    Ctrl --> : 204 No Content
  end
end

@enduml
