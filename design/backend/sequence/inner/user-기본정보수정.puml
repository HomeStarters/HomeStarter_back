@startuml user-기본정보수정
!theme mono

title User 서비스 내부 시퀀스 - 기본정보 수정 (UFR-USER-050 수정)

participant "Controller" as Controller
participant "AuthService" as AuthService
participant "UserService" as Service
participant "ValidationService" as Validation
participant "UserRepository" as Repository
database "User DB" as DB

== 기본정보 수정 API ==
Controller -> Controller: PUT /api/users/profile 요청 수신
note right
  Authorization: Bearer {token}
  {
    age: 29,
    maritalStatus: "MARRIED",
    numberOfChildren: 1,
    hasPet: false,
    currentResidence: "서울시 서초구"
  }
end note

Controller -> AuthService: validateToken(token)
AuthService -> AuthService: JWT 토큰 검증
note right
  - 토큰 서명 검증
  - 만료 시간 확인
  - 토큰에서 userId 추출
end note

alt 토큰 유효하지 않음
    AuthService --> Controller: UnauthorizedException
    Controller --> Controller: 401 Unauthorized 응답
else 토큰 유효
    AuthService --> Controller: userId

    Controller -> Validation: validateProfileRequest(request)
    Validation -> Validation: 필수 항목 검증
    note right
      - age: 19~100 범위 검증
      - maritalStatus: SINGLE/MARRIED 값 검증
      - numberOfChildren: 0 이상 검증
      - hasPet: boolean 검증
      - currentResidence: 2~100자 검증
    end note

    alt 검증 실패
        Validation --> Controller: ValidationException
        Controller --> Controller: 400 Bad Request 응답
    else 검증 통과
        Validation --> Controller: 검증 성공

        Controller -> Service: updateUserProfile(userId, profileRequest)
        Service -> Repository: findById(userId)
        Repository -> DB: SELECT * FROM users WHERE id = {userId}
        DB --> Repository: User Entity
        Repository --> Service: User

        alt 사용자 없음
            Service --> Controller: NotFoundException("사용자를 찾을 수 없습니다")
            Controller --> Controller: 404 Not Found 응답
        else 사용자 존재
            Service -> Repository: findProfileByUserId(userId)
            Repository -> DB: SELECT * FROM user_profiles\nWHERE user_id = {userId}
            DB --> Repository: UserProfile Entity
            Repository --> Service: UserProfile

            alt 프로필 없음
                Service --> Controller: NotFoundException("기본정보가 등록되어 있지 않습니다")
                Controller --> Controller: 404 Not Found 응답
                note right
                  먼저 POST /api/users/profile로
                  기본정보를 입력해야 함
                end note
            else 프로필 존재
                Service -> Service: UserProfile 업데이트
                note right
                  기존 UserProfile 엔티티의 필드 업데이트:
                  - age: 29
                  - maritalStatus: MARRIED
                  - numberOfChildren: 1
                  - hasPet: false
                  - currentResidence: "서울시 서초구"
                  - updatedAt: LocalDateTime.now()
                end note

                Service -> Repository: save(userProfile)
                Repository -> DB: UPDATE user_profiles\nSET age = {age},\n    marital_status = {maritalStatus},\n    number_of_children = {numberOfChildren},\n    has_pet = {hasPet},\n    current_residence = {currentResidence},\n    updated_at = NOW()\nWHERE user_id = {userId}
                DB --> Repository: 업데이트 완료
                Repository --> Service: UserProfile

                Service --> Controller: ProfileResponse
                note right
                  {
                    userId: "user-id",
                    age: 29,
                    maritalStatus: "MARRIED",
                    numberOfChildren: 1,
                    hasPet: false,
                    currentResidence: "서울시 서초구",
                    updatedAt: "2025-01-16T14:30:00Z"
                  }
                end note

                Controller --> Controller: 200 OK 응답
            end
        end
    end
end

@enduml
